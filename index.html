<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Психологический Тест</title>
  <!-- Подключение библиотеки для создания диаграмм -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Подключение библиотеки для создания PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Стили, основанные на вашем файле, для создания темной и стильной темы */
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #111;
      color: #eee;
      padding: 30px;
      line-height: 1.6;
    }
    .container-box {
      max-width: 700px;
      margin: auto;
      background: #1e1e1e;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); /* Золотистое свечение */
      margin-bottom: 40px;
      border: 1px solid rgba(255, 215, 0, 0.1);
    }
    h2, h3 {
        color: #fdd835; /* Золотой цвет для заголовков */
    }
    p {
        color: #ddd;
    }
    input[type="text"] {
        width: calc(100% - 22px);
        padding: 10px;
        margin-top: 10px;
        border-radius: 8px;
        border: 1px solid #444;
        background-color: #222;
        color: #eee;
        font-size: 1em;
    }
    button {
      margin: 10px;
      background-color: #8bc34a; /* Яркий зеленый */
      border: none;
      padding: 12px 25px;
      color: #000;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }
    button:hover {
        background-color: #9ccc65; /* Более светлый зеленый при наведении */
        transform: translateY(-2px);
    }
    button:disabled {
        background-color: #555;
        cursor: not-allowed;
    }
    #downloadBtn {
        background-color: #fdd835; /* Золотой для кнопки скачивания */
    }
    #downloadBtn:hover {
        background-color: #ffeb3b;
    }
    .gemini-btn {
        background-color: #673ab7; /* Фиолетовый для кнопок Gemini */
        color: #fff;
    }
    .gemini-btn:hover {
        background-color: #7e57c2;
    }
    .button-group {
        text-align: center;
    }
    .charts-container {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
      justify-content: center;
      margin-top: 20px;
    }
    .chart-wrapper {
      width: 300px;
      background: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    #progress {
        text-align: center;
        margin-top: 20px;
        color: #aaa;
        font-style: italic;
    }
    #geminiAnalysisBox {
        margin-top: 30px;
        padding: 20px;
        background-color: #2a2a2a;
        border-radius: 12px;
        border: 1px solid #444;
        white-space: pre-wrap; /* Сохраняет форматирование текста от Gemini */
        font-size: 1.1em;
        color: #e0e0e0;
    }
    .loader {
        text-align: center;
        padding: 20px;
        font-size: 1.2em;
        color: #fdd835;
        display: none; /* Скрыт по умолчанию */
    }
  </style>
</head>
<body>
  <!-- Блок для ввода имени пользователя -->
  <div class="container-box" id="nameBox">
    <h2>Добро пожаловать в Психологический Анализ</h2>
    <p>Этот тест состоит из 600 вопросов, разработанных для глубокого анализа 50 черт вашей личности. Отвечайте честно, чтобы получить наиболее точный результат. Ваши ответы помогут построить подробный психологический портрет.</p>
    <p>Пожалуйста, введите ваше имя, чтобы начать:</p>
    <input type="text" id="username" placeholder="Ваше имя или псевдоним" />
    <div class="button-group">
        <button onclick="startTest()">Начать Тест</button>
    </div>
  </div>

  <!-- Блок для отображения вопросов -->
  <div class="container-box" id="questionBox" style="display:none">
    <h3 id="questionText"></h3>
    <div class="button-group">
        <button onclick="answer(1)">Да</button>
        <button onclick="answer(3)">Иногда</button>
        <button onclick="answer(2)">Нет</button>
    </div>
    <p id="progress"></p>
    <div class="button-group">
        <button id="midResultsBtn" style="display:none" onclick="showResults(true)">Показать промежуточные результаты</button>
    </div>
  </div>

  <!-- Блок для отображения результатов и диаграмм -->
  <div class="container-box" id="resultBox" style="display:none">
    <h2>Результаты для <span id="userNameResult"></span></h2>
    <p>Ниже представлены диаграммы, отражающие уровень выраженности каждой из 50 черт вашей личности. PDF-отчет будет содержать визуальное представление этих диаграмм.</p>
    <div class="charts-container" id="charts"></div>
    <div class="button-group">
        <button id="downloadBtn" onclick="downloadPDF()">Скачать Отчет с Диаграммами в PDF</button>
    </div>
    

  <script>
    // Объект для хранения очков по каждой черте
    const traits = {};
    // Массив с названиями 50 черт личности
    const traitKeys = [
      "Целеустремлённость", "Эмпатия", "Интроверсия", "Экстраверсия", "Самоконтроль",
      "Открытость опыту", "Организованность", "Невротизм", "Агрессивность", "Уверенность в себе",
      "Креативность", "Чувство юмора", "Склонность к риску", "Альтруизм", "Тревожность",
      "Самооценка", "Толерантность", "Дисциплина", "Мотивация достижения", "Честность",
      "Инициативность", "Усидчивость", "Терпеливость", "Эстетика", "Лидерство",
      "Командность", "Сострадание", "Цинизм", "Жизнерадостность", "Рефлексия",
      "Мудрость", "Наблюдательность", "Чистоплотность", "Скромность", "Сила воли",
      "Интуиция", "Рациональность", "Эмоциональность", "Любознательность", "Справедливость",
      "Амбициозность", "Прямолинейность", "Идеализм", "Гибкость мышления", "Миролюбие",
      "Пунктуальность", "Прощение", "Стабильность", "Мнительность", "Самоанализ"
    ];
    // Инициализация очков для каждой черты
    traitKeys.forEach(t => traits[t] = 0);

    // База данных из 600 вопросов, сгруппированных по 50 чертам (по 12 на каждую)
    const questionsByTrait = {
        "Целеустремлённость": [
            "Вы ставите долгосрочные цели и упорно идёте к ним?", "Вы легко бросаете начатое, если сталкиваетесь с трудностями?",
            "Вы составляете план действий для достижения своих целей?", "Вас мотивирует конечный результат, а не сам процесс?",
            "Вы готовы пожертвовать сиюминутными удовольствиями ради будущих достижений?", "Вы считаете, что настойчивость важнее таланта?",
            "Вы часто откладываете важные дела на потом?", "Вы гордитесь своими достижениями?",
            "Вы легко отвлекаетесь от поставленной задачи?", "Вы считаете себя амбициозным человеком?",
            "Вам важно всегда доводить дело до конца?", "Вы теряете интерес, если не видите быстрого прогресса?"
        ],
        "Эмпатия": [
            "Вы часто переживаете за чувства других?", "Вам легко понять, что чувствует другой человек, даже если он об этом не говорит?",
            "Вы плачете во время просмотра грустных фильмов?", "Вы стараетесь помочь, когда видите, что кто-то расстроен?",
            "Вам сложно сказать «нет», чтобы не обидеть человека?", "Вы чувствуете себя истощённым после общения с эмоциональными людьми?",
            "Вы считаете себя хорошим слушателем?", "Вас трогает чужая доброта?",
            "Вы можете «заразиться» настроением окружающих?", "Вы стараетесь избегать конфликтов, чтобы не ранить чувства других?",
            "Вам больно видеть страдания животных?", "Вы можете поставить себя на место другого человека?"
        ],
        "Интроверсия": [
            "Вы предпочитаете проводить время в одиночестве, а не в большой компании?", "Вам нужно время, чтобы «перезарядиться» после общения?",
            "Вы лучше думаете, когда находитесь в тишине?", "Вы предпочитаете глубокие разговоры один на один, а не светские беседы?",
            "У вас немного близких друзей, но отношения с ними очень глубокие?", "Вы чувствуете себя неловко в центре внимания?",
            "Вы сначала думаете, а потом говорите?", "Вам нравится работать самостоятельно?",
            "Вы любите наблюдать за людьми со стороны?", "Вам сложно заводить новые знакомства?",
            "Вы цените тишину и спокойствие?", "Большие вечеринки вас утомляют?"
        ],
        "Экстраверсия": [
            "Вы получаете энергию от общения с людьми?", "Вам нравится быть в центре внимания?",
            "Вы легко заводите новые знакомства?", "Вы предпочитаете работать в команде, а не в одиночку?",
            "Вы сначала говорите, а потом думаете?", "Вам скучно, когда вы долго находитесь в одиночестве?",
            "Вы любите большие компании и вечеринки?", "Вы открыто выражаете свои мысли и чувства?",
            "Вы любите быть инициатором разговора?", "У вас широкий круг знакомых?",
            "Вы любите активный отдых в компании?", "Вам нравится знакомиться с новыми людьми?"
        ],
        "Самоконтроль": [
            "Вы легко можете отказать себе в удовольствии ради большего результата?", "Вы придерживаетесь диеты или плана тренировок?",
            "Вы всегда выполняете обещания, данные себе?", "Вам сложно удержаться от импульсивных покупок?",
            "Вы можете сдержать гнев в конфликтной ситуации?", "Вы всегда доводите начатое до конца, даже если скучно?",
            "Вы планируете свой бюджет и придерживаетесь его?", "Вы можете заставить себя делать то, что вам не нравится, но необходимо?",
            "Вы легко поддаётесь искушениям?", "Вы можете промолчать, когда очень хочется высказаться?",
            "Вы придерживаетесь своего распорядка дня?", "Вы можете контролировать свои эмоции на публике?"
        ],
        "Открытость опыту": [
            "Вы открыты новым идеям и взглядам?", "Вам нравится пробовать новую еду и посещать новые места?",
            "Вы любите искусство и цените красоту?", "Вы часто фантазируете и мечтаете?",
            "Вам интересно узнавать о других культурах?", "Вы предпочитаете рутину и предсказуемость?",
            "Вам нравится решать сложные и абстрактные задачи?", "Вы считаете, что у всего есть практическое применение?",
            "Вам нравится обсуждать философские темы?", "Вы легко меняете своё мнение под влиянием новых фактов?",
            "Вы любите посещать музеи и выставки?", "Вам интересно пробовать себя в новых хобби?"
        ],
        "Организованность": [
            "Вы любите порядок и планирование?", "Ваше рабочее место всегда в порядке?",
            "Вы составляете списки дел?", "Вы всегда приходите на встречи вовремя?",
            "Вы чувствуете дискомфорт, когда что-то идёт не по плану?", "Вы заранее готовитесь к важным событиям?",
            "Вы часто теряете свои вещи?", "Вы предпочитаете спонтанность планированию?",
            "Вы аккуратно ведёте свои записи?", "Вы считаете себя методичным человеком?",
            "Вы убираетесь в своей комнате регулярно?", "Вам нравится, когда у каждой вещи есть своё место?"
        ],
        "Невротизм": [
            "Вы часто ощущаете тревожность или нестабильность в эмоциях?", "Вы легко расстраиваетесь из-за мелочей?",
            "Вы часто беспокоитесь о будущем?", "Вы склонны к перепадам настроения?",
            "Вы долго переживаете после неудач?", "Вы часто чувствуете себя подавленным?",
            "Вы очень самокритичны?", "Вы легко обижаетесь?",
            "Вы часто испытываете чувство вины?", "Вам сложно расслабиться?",
            "Вы принимаете всё близко к сердцу?", "Вы часто чувствуете нервное напряжение?"
        ],
        "Агрессивность": [
            "Вы часто вспыльчивы или раздражительны?", "Вы можете накричать на кого-то в споре?",
            "Вам нравится соревноваться и побеждать?", "Вы склонны к сарказму?",
            "Вы легко вступаете в конфликт, чтобы отстоять свою точку зрения?", "Вы можете быть резким в своих высказываниях?",
            "Вы считаете, что лучший способ защиты — это нападение?", "Вы долго помните обиды?",
            "Вы можете использовать физическую силу в конфликте?", "Вы получаете удовольствие от споров?",
            "Вы считаете, что люди должны бороться за свои права?", "Вы бываете нетерпимы к чужим недостаткам?"
        ],
        "Уверенность в себе": [
            "Вы уверены в себе и своих силах?", "Вы легко принимаете комплименты?",
            "Вы не боитесь высказывать своё мнение, даже если оно отличается от мнения большинства?", "Вы считаете себя привлекательным?",
            "Вы спокойно реагируете на критику?", "Вы часто сомневаетесь в своих решениях?",
            "Вы считаете себя достойным успеха?", "Вы боитесь пробовать новое из-за страха неудачи?",
            "Вы легко выступаете перед аудиторией?", "Вы чувствуете себя комфортно в общении с незнакомыми людьми?",
            "Вы гордитесь своими уникальными качествами?", "Вы считаете, что заслуживаете самого лучшего?"
        ],
        "Креативность": [
            "Вы любите придумывать оригинальные идеи или решения?", "Вам нравится заниматься творчеством (рисование, музыка, писательство)?",
            "Вы видите необычное в обычных вещах?", "Вам нравится решать задачи, у которых нет одного правильного ответа?",
            "Вы часто используете своё воображение?", "Вы предпочитаете следовать инструкциям, а не импровизировать?",
            "Вы находите нестандартные выходы из сложных ситуаций?", "Вам нравится создавать что-то новое своими руками?",
            "Вы считаете себя человеком с богатым воображением?", "Вам нравится экспериментировать?",
            "Вы цените оригинальность в других людях?", "Вы легко генерируете новые идеи?"
        ],
        "Чувство юмора": [
            "Вы часто шутите и легко вызываете смех?", "Вы понимаете и цените хороший юмор?",
            "Вы можете посмеяться над собой?", "Вы используете юмор, чтобы разрядить напряжённую обстановку?",
            "Вы считаете, что юмор помогает справиться с трудностями?", "Вы обижаетесь на шутки в свой адрес?",
            "Вы считаете себя остроумным человеком?", "Вам нравится смотреть комедии и юмористические шоу?",
            "Вы любите рассказывать анекдоты?", "Вы можете найти смешное в любой ситуации?",
            "Вы цените в людях умение шутить?", "Вы легко находите повод для смеха?"
        ],
        "Склонность к риску": [
            "Вы готовы рисковать ради достижения чего-то большего?", "Вам нравятся экстремальные виды спорта?",
            "Вы любите азартные игры?", "Вы часто принимаете спонтанные решения?",
            "Вы бы поехали в путешествие без чёткого плана?", "Вы предпочитаете стабильность и предсказуемость?",
            "Вы готовы вложить деньги в рискованный проект?", "Вам нравится ощущение адреналина?",
            "Вы считаете, что «кто не рискует, тот не пьёт шампанского»?", "Вы боитесь неопределённости?",
            "Вы любите пробовать то, что никогда не делали раньше?", "Вы бы нарушили правила ради интересного приключения?"
        ],
        "Альтруизм": [
            "Вы помогаете людям, даже если это требует жертв?", "Вы получаете удовольствие от помощи другим?",
            "Вы занимаетесь волонтёрством или благотворительностью?", "Вы готовы поделиться последним с другом?",
            "Вы ставите интересы других выше своих собственных?", "Вы считаете, что каждый должен заботиться только о себе?",
            "Вы сочувствуете бездомным людям и животным?", "Вы готовы потратить своё время, чтобы помочь кому-то?",
            "Вы считаете, что доброта спасёт мир?", "Вы бы отдали свою вещь тому, кто в ней больше нуждается?",
            "Вы часто делаете пожертвования?", "Вы верите в бескорыстную помощь?"
        ],
        "Тревожность": [
            "Вы часто волнуетесь о будущем?", "Вы переживаете из-за того, что о вас подумают другие?",
            "Вы часто прокручиваете в голове негативные сценарии?", "Вам сложно заснуть из-за тревожных мыслей?",
            "Вы испытываете физические симптомы тревоги (учащённое сердцебиение, потливость)?", "Вы считаете себя спокойным и уравновешенным человеком?",
            "Вы боитесь принимать важные решения?", "Вы часто чувствуете беспричинное беспокойство?",
            "Вы избегаете ситуаций, которые вызывают у вас тревогу?", "Вы часто перепроверяете свои действия?",
            "Вы нуждаетесь в одобрении окружающих?", "Вам кажется, что должно случиться что-то плохое?"
        ],
        "Самооценка": [
            "Вы считаете себя достойным уважения и любви?", "Вы довольны своей внешностью?",
            "Вы гордитесь своими способностями и талантами?", "Вы часто сравниваете себя с другими не в свою пользу?",
            "Вы можете спокойно говорить о своих недостатках?", "Вы считаете, что заслуживаете счастья?",
            "Вы зависите от мнения окружающих о вас?", "Вы умеете принимать комплименты без смущения?",
            "Вы чувствуете себя уверенно в новой компании?", "Вы считаете, что ваши достижения случайны?",
            "Вы любите себя таким, какой вы есть?", "Вы можете постоять за себя и свои интересы?"
        ],
        "Толерантность": [
            "Вы спокойно относитесь к чужим взглядам и образу жизни?", "Вы считаете, что все люди равны, независимо от их расы, религии или ориентации?",
            "Вы готовы общаться с людьми, чьи убеждения кардинально отличаются от ваших?", "Вас раздражают люди, которые ведут себя «не так, как все»?",
            "Вы считаете, что есть только одно правильное мнение — ваше?", "Вы можете признать, что были неправы в споре?",
            "Вы уважаете чужие традиции и обычаи?", "Вы считаете, что инакомыслие — это нормально?",
            "Вы легко находите общий язык с разными людьми?", "Вы осуждаете людей за их выбор?",
            "Вы считаете, что разнообразие делает мир интереснее?", "Вы готовы учиться у людей с другим опытом?"
        ],
        "Дисциплина": [
            "Вы придерживаетесь режима и обязательств?", "Вы всегда выполняете то, что запланировали?",
            "Вы можете заставить себя работать, даже когда нет настроения?", "Вы легко поддаётесь лени?",
            "Вы считаете себя организованным человеком?", "Вы можете долго и усердно работать над одной задачей?",
            "Вы всегда держите своё слово?", "Вы считаете, что без дисциплины невозможно добиться успеха?",
            "Вы откладываете неприятные дела на потом?", "Вы можете отказаться от развлечений ради работы или учёбы?",
            "Вы следуете правилам, даже если никто не смотрит?", "Вы считаете себя ответственным человеком?"
        ],
        "Мотивация достижения": [
            "Вас мотивирует желание быть лучше других?", "Вы ставите перед собой амбициозные цели?",
            "Вам важен статус и признание?", "Вы любите соревноваться и выигрывать?",
            "Вы готовы много работать ради карьерного роста?", "Вы предпочитаете избегать сложных задач?",
            "Вы гордитесь своими успехами и любите о них рассказывать?", "Вы стремитесь быть первым во всём, что делаете?",
            "Вас вдохновляют истории успеха других людей?", "Вы считаете, что успех измеряется деньгами и властью?",
            "Вы готовы пойти на многое ради победы?", "Вы сравниваете свои достижения с достижениями других?"
        ],
        "Честность": [
            "Вы не врёте, даже если правда может повредить вам?", "Вы всегда возвращаете долги вовремя?",
            "Вы бы вернули найденный кошелёк с деньгами?", "Вы можете солгать, чтобы избежать неприятностей?",
            "Вы считаете, что иногда ложь во благо?", "Вы всегда говорите то, что думаете?",
            "Вы можете признаться в своей ошибке, даже если это грозит наказанием?", "Вы никогда не списывали на экзаменах?",
            "Вы считаете честность одним из главных качеств человека?", "Вы бы рассказали правду, даже если бы это навредило вашему другу?",
            "Вы осуждаете людей за ложь?", "Вы всегда искренни со своими близкими?"
        ],
        "Инициативность": [
            "Вы часто предлагаете новые идеи?", "Вы любите начинать новые проекты?",
            "Вы ждёте, пока вам скажут, что делать, или действуете сами?", "Вы не боитесь брать на себя ответственность?",
            "Вы легко находите, чем себя занять?", "Вы предпочитаете быть ведомым, а не лидером?",
            "Вы первым вызываетесь помочь?", "Вы видите возможности там, где другие видят проблемы?",
            "Вы активно участвуете в обсуждениях и дебатах?", "Вы считаете, что лучше сделать и пожалеть, чем не сделать и пожалеть?",
            "Вы легко воодушевляете других своими идеями?", "Вы всегда ищете способы улучшить то, что вас окружает?"
        ],
        "Усидчивость": [
            "Вы можете долго заниматься монотонной работой?", "Вы доводите до конца скучные, но важные задачи?",
            "Вы легко отвлекаетесь на посторонние вещи?", "Вам сложно сконцентрироваться на чём-то одном надолго?",
            "Вы можете часами читать книгу или смотреть фильм, не отрываясь?", "Вы предпочитаете задачи, которые можно выполнить быстро?",
            "Вы считаете себя терпеливым человеком?", "Вы можете кропотливо работать над мелкими деталями?",
            "Вас раздражает необходимость долго ждать результата?", "Вы можете заниматься одним делом несколько часов подряд?",
            "Вы бросаете начатое, если оно кажется вам слишком сложным?", "Вы можете медитировать или заниматься практиками, требующими концентрации?"
        ],
        "Терпеливость": [
            "Вы можете спокойно стоять в длинной очереди?", "Вас раздражают медлительные люди?",
            "Вы можете дождаться подходящего момента, не торопя события?", "Вы часто перебиваете собеседника?",
            "Вы готовы долго учиться, чтобы овладеть новым навыком?", "Вы хотите получать всё и сразу?",
            "Вы можете спокойно объяснять что-то несколько раз?", "Вас выводит из себя, когда что-то не получается с первого раза?",
            "Вы можете отложить удовольствие на потом?", "Вы считаете, что терпение и труд всё перетрут?",
            "Вы легко выходите из себя, когда ждёте чего-то?", "Вы можете досмотреть до конца длинный и скучный фильм?"
        ],
        "Эстетика": [
            "Вы цените красоту в искусстве и природе?", "Вам важен внешний вид еды, которую вы едите?",
            "Вы обращаете внимание на дизайн и архитектуру?", "Вам нравится окружать себя красивыми вещами?",
            "Вы чувствительны к гармонии цветов и форм?", "Вы считаете, что главное — функциональность, а не красота?",
            "Вам нравится посещать картинные галереи и театры?", "Вы замечаете красоту в повседневных вещах?",
            "Вам важен ваш собственный внешний вид и стиль?", "Вас может глубоко тронуть музыка или стихотворение?",
            "Вы предпочитаете красивые, но непрактичные вещи?", "Вы считаете, что красота спасёт мир?"
        ],
        "Лидерство": [
            "Вам нравится брать на себя руководство в группе?", "Люди часто прислушиваются к вашему мнению?",
            "Вы умеете мотивировать и вдохновлять других?", "Вы не боитесь принимать решения за всю команду?",
            "Вы предпочитаете подчиняться, а не руководить?", "Вы можете организовать людей для достижения общей цели?",
            "Вы берёте на себя ответственность за неудачи команды?", "Вы считаете себя прирождённым лидером?",
            "Вам нравится быть в центре внимания и вести за собой людей?", "Вы можете чётко и ясно излагать свои мысли?",
            "Вы умеете разрешать конфликты в коллективе?", "Вы готовы вести за собой людей, даже если это рискованно?"
        ],
        "Командность": [
            "Вам нравится работать в коллективе?", "Вы считаете, что вместе можно добиться большего, чем в одиночку?",
            "Вы легко находите общий язык с коллегами?", "Вы готовы пойти на компромисс ради общей цели?",
            "Вы предпочитаете работать в одиночестве?", "Вы умеете слушать и слышать других членов команды?",
            "Вы делитесь своими идеями с командой?", "Вы поддерживаете своих товарищей по команде?",
            "Вы считаете, что в команде важен каждый участник?", "Вы готовы выполнять свою часть работы ради общего успеха?",
            "Вы радуетесь успехам команды как своим собственным?", "Вы можете доверять своим коллегам?"
        ],
        "Сострадание": [
            "Вы чувствуете боль другого человека как свою собственную?", "Вы стараетесь помочь тем, кому повезло меньше, чем вам?",
            "Вы можете проявить сочувствие даже к тем, кто вам не нравится?", "Вы считаете, что чужих бед не бывает?",
            "Вас трогают истории о людях, попавших в беду?", "Вы считаете, что каждый сам за себя?",
            "Вы можете заплакать от сочувствия?", "Вы готовы пожертвовать своим комфортом, чтобы помочь другому?",
            "Вы стараетесь не судить людей, не зная их истории?", "Вы верите в то, что добро всегда возвращается?",
            "Вы участвуете в благотворительных акциях?", "Вы чувствуете потребность заботиться о ком-то?"
        ],
        "Цинизм": [
            "Вы считаете, что людьми движет только корысть?", "Вы с подозрением относитесь к проявлениям доброты?",
            "Вы часто используете сарказм и иронию?", "Вы верите в бескорыстную дружбу и любовь?",
            "Вы считаете, что большинство людей глупы?", "Вы разочарованы в человечестве?",
            "Вы считаете, что идеалов не существует?", "Вы смеётесь над тем, что другие считают святым?",
            "Вы считаете, что миром правят деньги и власть?", "Вы не доверяете обещаниям политиков и рекламы?",
            "Вы считаете, что романтика — это для наивных?", "Вы верите, что любой человек может предать?"
        ],
        "Жизнерадостность": [
            "Вы часто улыбаетесь и смеётесь?", "Вы смотрите на жизнь с оптимизмом?",
            "Вы легко находите повод для радости?", "Вы считаете себя счастливым человеком?",
            "Вы умеете наслаждаться моментом?", "Вы часто бываете в плохом настроении?",
            "Вы легко заражаете других своим хорошим настроением?", "Вы видите в трудностях возможности, а не проблемы?",
            "Вы любите праздники и веселье?", "Вы считаете, что жизнь прекрасна?",
            "Вы просыпаетесь утром с хорошим настроением?", "Вы благодарны за то, что у вас есть?"
        ],
        "Рефлексия": [
            "Вы часто анализируете свои поступки и мысли?", "Вы ведёте дневник или записываете свои размышления?",
            "Вы пытаетесь понять причины своих чувств и эмоций?", "Вы делаете выводы из своих ошибок?",
            "Вы считаете, что самопознание — это важно?", "Вы предпочитаете действовать, а не размышлять?",
            "Вы часто думаете о смысле жизни?", "Вы можете посмотреть на себя со стороны?",
            "Вы интересуетесь психологией?", "Вы стремитесь понять свои сильные и слабые стороны?",
            "Вы анализируете свои сны?", "Вы любите проводить время в размышлениях?"
        ],
        "Мудрость": [
            "Вы учитесь на своих и чужих ошибках?", "Вы можете дать дельный совет?",
            "Вы смотрите на вещи с разных точек зрения?", "Вы понимаете, что не всё в жизни чёрно-белое?",
            "Вы умеете принимать взвешенные решения?", "Вы считаете, что с возрастом приходит мудрость?",
            "Вы можете сохранять спокойствие в сложных ситуациях?", "Вы цените опыт больше, чем знания?",
            "Вы умеете прощать и отпускать обиды?", "Вы понимаете, что не можете всё контролировать?",
            "Вы стремитесь к гармонии с собой и миром?", "Вы считаете, что главное в жизни — это любовь и доброта?"
        ],
        "Наблюдательность": [
            "Вы замечаете мелкие детали, которые упускают другие?", "Вы можете по выражению лица понять настроение человека?",
            "Вы хорошо ориентируетесь в незнакомом месте?", "Вы помните детали событий, которые происходили давно?",
            "Вы любите наблюдать за людьми и их поведением?", "Вы часто витаете в облаках?",
            "Вы можете заметить изменения во внешности друга?", "Вы хорошо запоминаете лица и имена?",
            "Вы можете предсказать, как поведёт себя человек в той или иной ситуации?", "Вы замечаете красоту в мелочах?",
            "Вы хороший детектив в бытовых вопросах?", "Вы можете по нескольким признакам составить общую картину?"
        ],
        "Чистоплотность": [
            "Вам важен порядок в доме и на рабочем месте?", "Вы регулярно делаете уборку?",
            "Вас раздражает беспорядок?", "Вы всегда моете руки перед едой?",
            "Вы следите за своей личной гигиеной?", "Вы можете спокойно жить в неубранной комнате?",
            "Вы аккуратно относитесь к своим вещам?", "Вам нравится, когда всё лежит на своих местах?",
            "Вы считаете, что чистота — залог здоровья?", "Вы брезгливы?",
            "Вы всегда выбрасываете мусор в урну?", "Вы обращаете внимание на чистоту в общественных местах?"
        ],
        "Скромность": [
            "Вы не любите хвастаться своими достижениями?", "Вы смущаетесь, когда вас хвалят?",
            "Вы считаете, что дела говорят громче слов?", "Вы не стремитесь быть в центре внимания?",
            "Вы предпочитаете уступать другим?", "Вы считаете себя лучше других?",
            "Вы можете признать свои заслуги?", "Вы принижаете свои способности?",
            "Вы считаете, что скромность украшает человека?", "Вы не любите говорить о себе?",
            "Вы одеваетесь неброско?", "Вы считаете, что нужно быть проще?"
        ],
        "Сила воли": [
            "Вы можете заставить себя сделать то, что не хочется, но нужно?", "Вы можете противостоять соблазнам?",
            "Вы всегда доводите начатое до конца?", "Вы можете придерживаться долгосрочной цели, несмотря на трудности?",
            "Вы легко сдаётесь, когда что-то не получается?", "Вы можете отказаться от вредных привычек?",
            "Вы считаете себя человеком с сильным характером?", "Вы можете выдержать боль или дискомфорт?",
            "Вы можете заставить себя встать рано утром, даже если не выспались?", "Вы можете контролировать свои желания?",
            "Вы можете побороть свою лень?", "Вы считаете, что сила воли — это мышца, которую можно тренировать?"
        ],
        "Интуиция": [
            "Вы часто доверяете своему внутреннему голосу?", "У вас бывало так, что вы предчувствовали какое-то событие?",
            "Вы можете «прочитать» человека с первого взгляда?", "Вы часто принимаете решения, основываясь на интуиции, а не на логике?",
            "Вы верите в шестое чувство?", "Вы всегда можете логически объяснить свои поступки?",
            "Вы чувствуете, когда вам лгут?", "Вам снятся вещие сны?",
            "Вы можете найти выход из ситуации, когда логика бессильна?", "Вы считаете, что интуиция — это просто совпадение?",
            "Вы чувствуете связь с природой или Вселенной?", "Вы можете доверять своим первым впечатлениям?"
        ],
        "Рациональность": [
            "Вы всегда принимаете решения, основываясь на фактах и логике?", "Вы анализируете все «за» и «против», прежде чем что-то сделать?",
            "Вы не поддаётесь эмоциям при принятии важных решений?", "Вы считаете, что у всего есть логическое объяснение?",
            "Вы скептически относитесь к мистике и суевериям?", "Вы часто действуете импульсивно?",
            "Вы любите точность и порядок?", "Вы считаете, что чувства мешают принимать правильные решения?",
            "Вы хорошо разбираетесь в точных науках?", "Вы можете составить чёткий план и следовать ему?",
            "Вы предпочитаете практичные вещи?", "Вы считаете, что разум должен контролировать чувства?"
        ],
        "Эмоциональность": [
            "Вы открыто выражаете свои чувства?", "Вы легко можете заплакать от счастья или грусти?",
            "Вы бурно реагируете на события?", "Вы считаете себя страстным человеком?",
            "Вы живёте сердцем, а не разумом?", "Вы скрываете свои истинные эмоции?",
            "Вы можете быть очень вспыльчивым?", "Ваше настроение часто меняется?",
            "Вы считаете, что нужно давать волю своим чувствам?", "Вы принимаете решения под влиянием эмоций?",
            "Вы любите драматизировать события?", "Вы считаете себя чувствительным человеком?"
        ],
        "Любознательность": [
            "Вам интересно, как устроен мир?", "Вы любите учиться новому?",
            "Вы часто задаёте вопросы «почему» и «как»?", "Вы любите читать книги и смотреть документальные фильмы?",
            "Вы легко увлекаетесь новыми темами?", "Вы считаете, что лучше меньше знать, но крепче спать?",
            "Вы любите путешествовать и открывать для себя новые места?", "Вы интересуетесь наукой и технологиями?",
            "Вы любите разгадывать загадки и головоломки?", "Вы считаете, что учение — свет?",
            "Вы всегда ищете новую информацию?", "Вы бы хотели знать ответы на все вопросы?"
        ],
        "Справедливость": [
            "Вы всегда заступаетесь за слабых?", "Вы считаете, что все должны быть равны перед законом?",
            "Вас возмущает несправедливость?", "Вы готовы бороться за правду?",
            "Вы считаете, что цель оправдывает средства?", "Вы всегда играете по правилам?",
            "Вы можете признать правоту другого человека в споре?", "Вы считаете, что каждый должен получать по заслугам?",
            "Вы бы пожертвовали своими интересами ради справедливости?", "Вы осуждаете людей, которые добиваются успеха нечестным путём?",
            "Вы верите в то, что справедливость восторжествует?", "Вы стараетесь быть объективным в своих оценках?"
        ],
        "Амбициозность": [
            "Вы стремитесь к успеху и признанию?", "Вы хотите достичь большего, чем другие?",
            "Вы мечтаете о высокой должности или большом богатстве?", "Вы готовы много работать, чтобы осуществить свои мечты?",
            "Вы довольствуетесь малым?", "Вы считаете себя лучше других?",
            "Вы завидуете успешным людям?", "Вы ставите перед собой труднодостижимые цели?",
            "Вы считаете, что нет ничего невозможного?", "Вы готовы конкурировать за место под солнцем?",
            "Вы любите быть лидером и вести за собой?", "Вы считаете, что скромность — это недостаток?"
        ],
        "Прямолинейность": [
            "Вы всегда говорите то, что думаете, прямо в лицо?", "Вы не любите намёков и недомолвок?",
            "Вы можете быть резким в своих суждениях?", "Вы считаете, что горькая правда лучше сладкой лжи?",
            "Вы обижаете людей своей прямотой?", "Вы предпочитаете промолчать, чтобы не обидеть человека?",
            "Вы цените в людях честность и открытость?", "Вы не боитесь высказывать критику?",
            "Вы считаете, что дипломатия — это лицемерие?", "Вы можете быть бестактным?",
            "Вы всегда называете вещи своими именами?", "Вы предпочитаете ясность в отношениях?"
        ],
        "Идеализм": [
            "Вы верите в то, что мир можно сделать лучше?", "Вы стремитесь к совершенству во всём?",
            "Вы верите в добро, любовь и справедливость?", "Вы разочарованы в людях и мире?",
            "Вы считаете, что у каждого человека есть светлая сторона?", "Вы мечтаете об идеальном обществе?",
            "Вы считаете, что реальность жестока и несправедлива?", "Вы готовы бороться за свои идеалы?",
            "Вы верите в то, что мечты сбываются?", "Вы считаете, что нужно стремиться к недостижимому?",
            "Вы романтик?", "Вы верите в высшую цель своего существования?"
        ],
        "Гибкость мышления": [
            "Вы легко адаптируетесь к новым условиям?", "Вы можете посмотреть на проблему с разных сторон?",
            "Вы легко меняете своё мнение, если вам приводят убедительные аргументы?", "Вы упрямы и всегда настаиваете на своём?",
            "Вам нравится находить несколько решений для одной задачи?", "Вы консервативны и не любите перемен?",
            "Вы можете признать, что существует несколько правильных точек зрения?", "Вы легко переключаетесь с одной задачи на другую?",
            "Вы открыты для всего нового и необычного?", "Вы предпочитаете действовать по шаблону?",
            "Вы можете импровизировать в непредвиденной ситуации?", "Вы считаете, что правила можно нарушать?"
        ],
        "Миролюбие": [
            "Вы избегаете конфликтов и ссор?", "Вы стремитесь к гармонии в отношениях?",
            "Вы умеете находить компромиссы?", "Вы считаете, что худой мир лучше доброй ссоры?",
            "Вы легко прощаете обиды?", "Вам нравится спорить и доказывать свою правоту?",
            "Вы можете уступить, чтобы сохранить хорошие отношения?", "Вы считаете, что насилие недопустимо ни в какой форме?",
            "Вы можете успокоить разбушевавшихся спорщиков?", "Вы верите в то, что все проблемы можно решить мирным путём?",
            "Вы не держите зла на людей?", "Вы желаете всем добра и счастья?"
        ],
        "Пунктуальность": [
            "Вы всегда приходите на встречи вовремя?", "Вас раздражает, когда другие опаздывают?",
            "Вы всегда сдаёте работу в срок?", "Вы планируете своё время, чтобы никуда не опаздывать?",
            "Вы часто опаздываете?", "Вы считаете, что точность — вежливость королей?",
            "Вы выходите из дома заранее, чтобы иметь запас времени?", "Вы можете пропустить важное событие из-за своей непунктуальности?",
            "Вы цените своё и чужое время?", "Вы считаете опоздание проявлением неуважения?",
            "Вы всегда предупреждаете, если задерживаетесь?", "Вы можете рассчитать время на дорогу с точностью до минуты?"
        ],
        "Прощение": [
            "Вы легко прощаете людей, которые вас обидели?", "Вы не держите зла и не помните обид?",
            "Вы считаете, что все заслуживают второго шанса?", "Вы можете простить предательство?",
            "Вы долго переживаете обиды?", "Вы считаете, что прощение — это проявление слабости?",
            "Вы можете понять и простить человека, который поступил плохо?", "Вы считаете, что месть — это блюдо, которое подают холодным?",
            "Вы верите, что прощение освобождает в первую очередь вас самих?", "Вы можете искренне пожелать добра своему обидчику?",
            "Вы можете простить себя за свои ошибки?", "Вы считаете, что некоторые вещи прощать нельзя?"
        ],
        "Стабильность": [
            "Вам важна предсказуемость и постоянство в жизни?", "Вы не любите перемены и сюрпризы?",
            "Вы предпочитаете иметь постоянную работу и стабильный доход?", "Вы цените надёжные и долгосрочные отношения?",
            "Вы боитесь неопределённости и хаоса?", "Вам нравится рутина?",
            "Вы бы предпочли жить в одном городе всю жизнь?", "Вы консервативны в своих привычках?",
            "Вам важна уверенность в завтрашнем дне?", "Вы избегаете рискованных и авантюрных затей?",
            "Вы стремитесь к созданию крепкой семьи и уютного дома?", "Вы считаете, что стабильность — признак успеха?"
        ],
        "Мнительность": [
            "Вы часто принимаете всё на свой счёт?", "Вы ищете скрытый смысл в словах и поступках людей?",
            "Вы часто думаете, что о вас плохо говорят за спиной?", "Вы легко обижаетесь на безобидные шутки?",
            "Вы подозреваете людей в недобрых намерениях?", "Вы доверяете людям?",
            "Вы часто перепроверяете информацию, потому что боитесь ошибки?", "Вы беспокоитесь о своём здоровье по малейшему поводу?",
            "Вы ревнивы?", "Вы считаете, что мир полон опасностей?",
            "Вы боитесь, что вас обманут или предадут?", "Вы анализируете каждый свой шаг из-за страха осуждения?"
        ],
        "Самоанализ": [
            "Вы часто размышляете о своих чувствах и поступках?", "Вы стремитесь понять, почему вы поступаете так, а не иначе?",
            "Вы пытаетесь найти корень своих проблем в себе?", "Вы ведёте дневник, чтобы лучше разобраться в себе?",
            "Вы считаете важным понимать свои сильные и слабые стороны?", "Вы предпочитаете не копаться в себе?",
            "Вы интересуетесь психологией и техниками саморазвития?", "Вы можете честно признаться себе в своих недостатках?",
            "Вы делаете выводы из своего жизненного опыта?", "Вы анализируете свои отношения с другими людьми?",
            "Вы стремитесь стать лучшей версией себя?", "Вы считаете, что ключ к счастью лежит в самопознании?"
        ]
    };

    const questions = [];
    // Создаем единый массив вопросов, сохраняя привязку к черте
    for (const trait in questionsByTrait) {
        questionsByTrait[trait].forEach(text => {
            questions.push({ text, trait });
        });
    }

    let currentQuestionIndex = 0;
    let userName = "";
    let finalScores = {};
    let chartInstances = [];

    // Функция для начала теста
    function startTest() {
      userName = document.getElementById("username").value.trim();
      if (!userName) {
        alert("Пожалуйста, введите ваше имя.");
        return;
      }
      document.getElementById("nameBox").style.display = 'none';
      document.getElementById("questionBox").style.display = 'block';
      displayQuestion();
    }

    // Функция для отображения текущего вопроса
    function displayQuestion() {
      document.getElementById("questionText").innerText = questions[currentQuestionIndex].text;
      document.getElementById("progress").innerText = `Вопрос ${currentQuestionIndex + 1} из ${questions.length}`;
      
      // Показываем кнопку промежуточных результатов после 100-го вопроса
      if (currentQuestionIndex >= 100) {
        document.getElementById("midResultsBtn").style.display = 'inline-block';
      }
    }

    // Функция для обработки ответа пользователя
    function answer(value) {
      if (value === 1) { // Да
        traits[questions[currentQuestionIndex].trait] += 2;
      } else if (value === 3) { // Иногда
        traits[questions[currentQuestionIndex].trait] += 1;
      }
      
      currentQuestionIndex++;
      
      if (currentQuestionIndex < questions.length) {
        displayQuestion();
      } else {
        showResults(false); // Показываем финальные результаты
      }
    }

    // Функция для отображения диаграмм с результатами
    function showResults(isIntermediate = false) {
      document.getElementById("questionBox").style.display = 'none';
      document.getElementById("resultBox").style.display = 'block';
      document.getElementById("userNameResult").innerText = userName;
      
      const chartsDiv = document.getElementById("charts");
      chartsDiv.innerHTML = ""; // Очищаем предыдущие диаграммы
      chartInstances = []; // Очищаем массив экземпляров диаграмм
      
      traitKeys.forEach((key, index) => {
        const wrapper = document.createElement("div");
        wrapper.className = "chart-wrapper";
        const canvas = document.createElement("canvas");
        canvas.id = `chart${index}`;
        wrapper.appendChild(canvas);
        chartsDiv.appendChild(wrapper);
        
        const questionsPerTrait = questionsByTrait[key].length;
        const maxPossibleScore = questionsPerTrait * 2; // Максимум 2 очка на вопрос

        let answeredQuestionsForTrait = 0;
        if (isIntermediate) {
            for(let i = 0; i < currentQuestionIndex; i++) {
                if(questions[i].trait === key) {
                    answeredQuestionsForTrait++;
                }
            }
        } else {
            answeredQuestionsForTrait = questionsPerTrait;
        }

        const maxScoreForCurrentState = answeredQuestionsForTrait * 2;
        
        const scorePercentage = maxScoreForCurrentState > 0 ? Math.min(100, Math.round((traits[key] / maxScoreForCurrentState) * 100)) : 0;
        
        if (!isIntermediate) {
            finalScores[key] = scorePercentage;
        }
       
        const chart = new Chart(canvas, {
          type: 'doughnut',
          data: {
            labels: [key, ''],
            datasets: [{
              data: [scorePercentage, 100 - scorePercentage],
              backgroundColor: ["#8bc34a", "#333"],
              borderColor: '#1e1e1e',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            animation: {
                // Отключаем анимацию для мгновенного рендеринга в PDF
                duration: 0
            },
            plugins: {
              legend: { display: false },
              title: {
                display: true,
                text: `${key}: ${scorePercentage}%`,
                color: '#fdd835',
                font: { size: 16, weight: 'bold' }
              }
            },
            cutout: "70%"
           }
        });
        chartInstances.push(chart);
      });
    }

    // --- Gemini API Integration ---

    async function callGemini(prompt) {
        const loader = document.getElementById('loader');
        const geminiBox = document.getElementById('geminiAnalysisBox');
        const geminiButtons = document.querySelectorAll('.gemini-btn');

        loader.style.display = 'block';
        geminiBox.style.display = 'none';
        geminiButtons.forEach(btn => btn.disabled = true);

        const apiKey = ""; // API-ключ будет предоставлен средой выполнения
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        
        let chatHistory = [];
        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
        const payload = { contents: chatHistory };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Ошибка API: ${response.statusText}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                const text = result.candidates[0].content.parts[0].text;
                geminiBox.innerText = text;
                geminiBox.style.display = 'block';
            } else {
                geminiBox.innerText = 'Не удалось получить анализ. Ответ от AI был в неожиданном формате.';
                geminiBox.style.display = 'block';
            }
        } catch (error) {
            console.error("Ошибка при вызове Gemini API:", error);
            geminiBox.innerText = `Произошла ошибка при обращении к AI. Пожалуйста, проверьте консоль для деталей или попробуйте позже. Ошибка: ${error.message}`;
            geminiBox.style.display = 'block';
        } finally {
            loader.style.display = 'none';
            geminiButtons.forEach(btn => btn.disabled = false);
        }
    }

    function getGeminiAnalysis() {
        let resultsString = "Вот результаты теста по 50 чертам личности (в процентах):\n";
        for (const trait in finalScores) {
            resultsString += `- ${trait}: ${finalScores[trait]}%\n`;
        }

        const prompt = `Ты — опытный психолог-аналитик. Проанализируй следующий психологический портрет пользователя по имени ${userName}. Вот его результаты: \n\n${resultsString}\n\nНапиши подробный, структурированный и понятный анализ. Опиши его сильные стороны, потенциальные зоны для роста и общий тип личности. Твой анализ должен быть конструктивным, поддерживающим и профессиональным. В конце дай краткое, но емкое заключение. Ответ предоставь на русском языке.`;
        
        callGemini(prompt);
    }

    // Функция для скачивания результатов в PDF
    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(20);
        doc.text(`Психологический Портрет: ${userName}`, doc.internal.pageSize.getWidth() / 2, 20, { align: "center" });
        
        const chartCanvases = document.querySelectorAll('.charts-container canvas');
        const margin = 15;
        const chartWidth = (doc.internal.pageSize.getWidth() - 3 * margin) / 2;
        const chartHeight = chartWidth; // Сохраняем пропорции
        let x = margin;
        let y = 30;

        for (let i = 0; i < chartCanvases.length; i++) {
            const canvas = chartCanvases[i];
            const imgData = canvas.toDataURL('image/png');

            if (y + chartHeight > doc.internal.pageSize.getHeight() - margin) {
                doc.addPage();
                y = 20; // Сброс Y для новой страницы
                x = margin; // Сброс X для новой страницы
            }
            
            doc.addImage(imgData, 'PNG', x, y, chartWidth, chartHeight);
            
            // Переключаем колонку
            if ((i + 1) % 2 === 0) {
                x = margin; // Возвращаемся в первую колонку
                y += chartHeight + 10; // Переходим на следующий ряд
            } else {
                x += chartWidth + margin; // Переходим во вторую колонку
            }
        }
      
        doc.save(`Psychological_Profile_${userName}.pdf`);
    }
  </script>
</body>
</html>
